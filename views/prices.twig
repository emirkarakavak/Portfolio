<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <title>E-Pin Fiyatları — Karşılaştırma</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --bg-deep:#0f172a;          /* sayfa zemini */
      /*--bg-table:#0b1224;          sticky left hücre zemini */
      --bar-track:#1f2937;        /* diff bar track */
      --price-cols: 4;            /* JS ile güncellenecek: Dijipin + rakip sayısı */
    }
    body{ background:var(--bg-deep); }
    .card{ border:none; }
    .price{ font-variant-numeric: tabular-nums; }
    .nav-tabs,.nav-pills{ flex-wrap:wrap; }
    .nav-tabs .nav-link,.nav-pills .nav-link{ margin-bottom:.5rem; }
    .product-row{ cursor:pointer; transition: background .15s, box-shadow .15s; }
    .product-row:hover{ background:rgba(255,255,255,.04); box-shadow: inset 0 0 0 1px rgba(255,255,255,.08); }
    .best-pill{ font-size:.72rem; letter-spacing:.01em; }
    .diff-pos{ color:#16a34a; }  /* Dijipin daha ucuz */
    .diff-neg{ color:#dc2626; }  /* Rakip daha ucuz */
    .diff-eq { color:#9ca3af; }  /* Eşit */

    /* --- sticky başlık + ilk sütun --- */
    .table-sticky thead th {
      position: sticky; top: 0; z-index: 3;
    }
    .table-sticky tbody td:first-child,
    .table-sticky thead th:first-child{
      position: sticky; left: 0; z-index: 2;
      background: var(--bg-table);
    }

    /* --- fixed layout + ellipsis sadece BAŞLIKLARDA --- */
    .table.table-fixed { table-layout: fixed; }
    .table.table-fixed thead th {
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle;
    }

    /* Ürün sütunu: harf harf kırma yok, kelimeye göre sar */
    .col-name {
      width:28%; min-width:220px;
      white-space: normal;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .col-price{ width:9rem; }
    .col-diff { width:9rem; }
    .col-tag  { width:10rem; }

    /* tablo enini minimumda tut, kalanını yatay scroll'a bırak */
    .table-sticky.table-fixed{
      min-width: calc(520px + var(--price-cols) * 9rem); /* 520 ~ ürün+diff+etiket, 9rem fiyat kolonu */
    }

    /* başlık görselliği */
    .table-dark { background: rgba(15,23,42,.85)!important; backdrop-filter: blur(6px); }

    /* en uygun hücre vurgusu */
    .cell-best{
      background: linear-gradient(0deg, rgba(34,197,94,.12), rgba(34,197,94,.12));
    }

    /* diff bar */
    .diff-wrap { display:flex; align-items:center; gap:.5rem; justify-content:flex-end; }
    .diff-bar  { height:6px; width:70px; border-radius:3px; background:var(--bar-track); overflow:hidden; }
    .diff-bar > i { display:block; height:100%; }

    /* sıralanabilir başlık görseli */
    .th-sort{ cursor:pointer; user-select:none; }
    .th-sort::after{ content:'⇅'; opacity:.55; margin-left:.25rem; font-size:.85em; }
    .th-sort[data-dir="asc"]::after { content:'↑'; }
    .th-sort[data-dir="desc"]::after{ content:'↓'; }

    /* skeleton loader */
    .skel {
      height: 1.25rem; border-radius:4px;
      background: linear-gradient(90deg, #1f2937 25%, #374151 37%, #1f2937 63%);
      background-size: 400% 100%; animation: skel 1.2s ease infinite;
    }
    @keyframes skel { 0%{background-position:100% 0} 100%{background-position:0 0} }

    @media (max-width: 768px){
      .col-name { min-width:160px; }
      .col-price{ width:7.5rem; }
      .col-diff { width:7.5rem; }
      .col-tag  { width:8.5rem; }
      .table.table-fixed thead th{ max-width: 120px; }
    }
  </style>
</head>
<body class="text-light">
<div class="container-fluid py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-xl-11">
      <div class="card shadow-lg">
        <div class="card-body p-0">

          <!-- Başlık -->
          <div class="p-4 border-bottom bg-dark text-white rounded-top">
            <h1 class="h4 mb-1">Ürün Fiyatları — Karşılaştırma</h1>
            <p class="mb-0 text-white-50">Kategori seç; tek tabloda Dijipin ile tüm rakipleri kıyasla.</p>
          </div>

          <!-- KATEGORİ SEKMESİ + FİLTRELER -->
          <div class="px-3 pt-3 pb-2 bg-dark-subtle">
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <ul class="nav nav-pills mb-0" id="categoryTabs" role="tablist">
                {% for cat in categories %}
                <li class="nav-item">
                  <button class="btn btn-outline-danger me-2 {{ loop.first ? 'active' : '' }}"
                          id="{{ cat.id }}-tab"
                          data-bs-toggle="tab"
                          data-bs-target="#{{ cat.id }}"
                          type="button" role="tab">
                    {{ cat.label }}
                  </button>
                </li>
                {% endfor %}
              </ul>

              <div class="ms-auto d-flex gap-2 flex-wrap">
                <input id="globalSearch" type="search" class="form-control form-control-sm" placeholder="Ürün ara… (örn: 60 UC)">
                <select id="whoCheaper" class="form-select form-select-sm" style="min-width:190px">
                  <option value="">Tümü</option>
                  <option value="dijipin">Sadece Dijipin daha ucuz</option>
                  <option value="competitor">Sadece Rakip daha ucuz</option>
                  <option value="equal">Fiyatlar eşit</option>
                </select>
                <div class="input-group input-group-sm" style="width:200px">
                  <span class="input-group-text">Min fark %</span>
                  <input id="minDiff" type="number" step="0.01" min="0" class="form-control" placeholder="örn 5">
                </div>
              </div>
            </div>
          </div>

          <!-- İÇERİK -->
          <div class="tab-content" id="categoryTabsContent">
            {% for cat in categories %}
            <div class="tab-pane fade {{ loop.first ? 'show active' : '' }}"
                 id="{{ cat.id }}" role="tabpanel" aria-labelledby="{{ cat.id }}-tab">

              <div class="table-responsive bg-body-tertiary">
                <table class="table table-hover table-borderless align-middle mb-0 table-sticky table-fixed">
                  <thead class="table-dark">
                  <tr id="{{ cat.id }}-head">
                    <!-- JS dinamik doldurur -->
                    <th class="col-name">Ürün</th>
                    <th class="text-end col-price th-sort" data-sort="dijipin" title="Dijipin (₺)">Dijipin (₺)</th>
                    <!-- Rakip kolonları buraya eklenecek -->
                    <th class="text-end col-diff th-sort" data-sort="diff">Fark (%)</th>
                    <th class="text-end col-tag">Etiket</th>
                  </tr>
                  </thead>
                  <tbody id="{{ cat.id }}-body">
                    <tr><td colspan="4"><div class="skel"></div></td></tr>
                  </tbody>
                </table>
              </div>

            </div>
            {% endfor %}
          </div>

          <div class="p-3 bg-dark text-white-50 rounded-bottom">
            <small>Fark % = (min rakip − Dijipin) / min rakip × 100 • Pozitifse Dijipin daha ucuz</small>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- JSON verisi: ESCAPE ETME, RAW BAS -->
<script id="cat-data" type="application/json">{{ categoriesJson|raw }}</script>

<!-- Modal: Tüm fiyatlar -->
<div class="modal fade" id="allPricesModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-scrollable modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title">Tüm fiyatlar</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="allPricesBody"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ---------- helpers ---------- */
const norm = s => (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();

function toNumberTRorUS(p){
  let x = String(p ?? '').replace(/[^\d.,-]/g,'').trim();
  if(!x) return null;
  if(/,\d{2}$/.test(x)){ x = x.replace(/\./g, ''); x = x.replace(/,/g, '.'); }
  else if(/\.\d{2}$/.test(x)){ x = x.replace(/,/g, ''); }
  else {
    const lastComma = x.lastIndexOf(','), lastDot = x.lastIndexOf('.');
    const i = Math.max(lastComma, lastDot);
    if(i > -1){
      const intPart  = x.slice(0, i).replace(/[.,]/g, '');
      const fracPart = x.slice(i+1).replace(/[^\d]/g, '');
      x = intPart + (fracPart ? '.' + fracPart : '');
    }
  }
  const v = Number(x);
  return Number.isFinite(v) ? v : null;
}
function fmt(n){ return n==null ? '-' : new Intl.NumberFormat('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}).format(n); }

/* ---------- render ---------- */
document.addEventListener('DOMContentLoaded', () => {
  let cats = [];
  try { cats = JSON.parse(document.getElementById('cat-data').textContent || '[]'); }
  catch(e){ console.error('categoriesJson parse hata:', e); return; }

  cats.forEach(cat => renderCategory(cat));

  // filtreler
  const searchInput=document.getElementById('globalSearch');
  const whoSel=document.getElementById('whoCheaper');
  const minDiff=document.getElementById('minDiff');

  function applyFilters(){
    const q=norm(searchInput.value);
    const who=whoSel.value;
    const minp=parseFloat(minDiff.value);
    const activePane=document.querySelector('.tab-pane.show.active');
    if(!activePane) return;
    const tbody=activePane.querySelector('tbody');
    const rows=tbody.querySelectorAll('tr.product-row');
    rows.forEach(tr=>{
      const name=norm(tr.dataset.name);
      const cheaper=tr.dataset.cheaper||'';
      const diff=parseFloat(tr.dataset.diff||'NaN');
      let show=true;
      if(q && !name.includes(q)) show=false;
      if(who && cheaper!==who) show=false;
      if(!Number.isNaN(minp) && !(diff>=minp)) show=false;
      tr.style.display=show?'':'none';
    });
    const visible=Array.from(rows).some(tr=>tr.style.display!=='none');
    let empty=tbody.querySelector('tr.__empty');
    const cols = activePane.querySelectorAll('thead th').length;
    if(!visible){
      if(!empty){ empty=document.createElement('tr'); empty.className='__empty';
        empty.innerHTML='<td colspan="'+cols+'" class="text-center text-muted">Kayıt yok</td>';
        tbody.appendChild(empty);
      }
    } else if(empty) empty.remove();
  }
  searchInput.addEventListener('input', applyFilters);
  whoSel.addEventListener('change', applyFilters);
  minDiff.addEventListener('input', applyFilters);
  document.querySelectorAll('#categoryTabs [data-bs-toggle="tab"]').forEach(btn=>{
    btn.addEventListener('shown.bs.tab', applyFilters);
  });

  // başlıklardan sıralama
  document.addEventListener('click', e=>{
    const th = e.target.closest('.th-sort'); if(!th) return;
    const pane = th.closest('.tab-pane'); if(!pane) return;
    const tbody = pane.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr.product-row'));
    const headCells = Array.from(pane.querySelectorAll('thead th'));
    const thIndex = headCells.indexOf(th);

    th.dataset.dir = th.dataset.dir==='asc' ? 'desc' : 'asc';
    const dir = th.dataset.dir;

    rows.sort((a,b)=>{
      const parseCell = (row, idx) => {
        const cell = row.querySelector(`td:nth-child(${idx+1})`);
        return toNumberTRorUS(cell?.textContent);
      };
      let av,bv;
      if(th.dataset.sort === 'diff'){
        av = parseFloat(a.dataset.diff||'NaN');
        bv = parseFloat(b.dataset.diff||'NaN');
      } else if(th.dataset.sort === 'dijipin'){
        av = parseCell(a, 1);  // 2. sütun
        bv = parseCell(b, 1);
      } else {
        av = parseCell(a, thIndex);
        bv = parseCell(b, thIndex);
      }
      if(isNaN(av)&&isNaN(bv)) return 0;
      if(isNaN(av)) return 1;
      if(isNaN(bv)) return -1;
      return dir==='asc' ? av-bv : bv-av;
    });
    rows.forEach(r=>tbody.appendChild(r));
  });

  applyFilters();
});

/* ---------- tek kategori render ---------- */
function renderCategory(cat){
  const pane = document.getElementById(cat.id);
  if(!pane){ console.warn('pane yok:', cat.id); return; }

  const sites = cat.sites || [];
  const dijipin = sites.find(s => /dijipin/i.test(s.id) || /dijipin/i.test(s.label));
  const competitors = sites.filter(s => s !== dijipin); // SINIRSIZ

  // thead'i dinamik kur
  const theadRow = pane.querySelector('thead tr');
  theadRow.innerHTML = `
    <th class="col-name">Ürün</th>
    <th class="text-end col-price th-sort" data-sort="dijipin" title="Dijipin (₺)">Dijipin (₺)</th>
  `;
  for(const comp of competitors){
    const th=document.createElement('th');
    th.className='text-end col-price th-sort';
    th.textContent=(comp.label || 'Rakip');
    th.title = (comp.label || 'Rakip');
    theadRow.appendChild(th);
  }
  theadRow.insertAdjacentHTML('beforeend', `
    <th class="text-end col-diff th-sort" data-sort="diff" title="(min rakip − Dijipin) / min rakip × 100">Fark (%)</th>
    <th class="text-end col-tag">Etiket</th>
  `);

  // >>> burada tabloya price column sayısını bildir (Dijipin + rakipler)
  const table = pane.querySelector('table');
  table?.style.setProperty('--price-cols', String(1 + competitors.length));

  // ürün haritası: { name, dijipin, comps: Map(siteId -> {label,val}) }
  const map = new Map();

  function upsertRow(siteObj, which){
    (siteObj?.rows || []).forEach(r=>{
      const key = r.name; if(!key) return;
      const priceStr = r.tr ?? r.global ?? r.price ?? null;
      const val = toNumberTRorUS(priceStr);
      if(val==null) return;

      const rec = map.get(key) || { name:key, dijipin:null, comps:new Map() };
      if(which==='dijipin') rec.dijipin = val;
      else rec.comps.set(siteObj.id, { label: siteObj.label, val });
      map.set(key, rec);
    });
  }
  if(dijipin) upsertRow(dijipin, 'dijipin');
  for(const comp of competitors) upsertRow(comp, 'comp');

  // satırları yaz
  const tbody = pane.querySelector('tbody');
  tbody.innerHTML='';
  const rows = Array.from(map.values()).sort((a,b)=> a.name.localeCompare(b.name,'tr'));

  for(const r of rows){
    const allPairs = [];
    if(r.dijipin!=null) allPairs.push(['__dijipin__', r.dijipin]);
    for(const [sid,obj] of r.comps) allPairs.push([sid, obj.val]);
    if(!allPairs.length) continue;

    const minVal = Math.min(...allPairs.map(p=>p[1]));
    const bestKeys = new Set(allPairs.filter(p=>p[1]===minVal).map(p=>p[0]));

    // fark% = (minCompetitor − dijipin)/minCompetitor*100
    const compVals = Array.from(r.comps.values()).map(x=>x.val);
    let diffPct=null, cheaper='equal';
    if(compVals.length && r.dijipin!=null){
      const minComp=Math.min(...compVals);
      diffPct=((minComp - r.dijipin)/minComp)*100;
      cheaper=(Math.abs(diffPct)<0.0001)?'equal':(diffPct>0?'dijipin':'competitor');
    } else if(r.dijipin!=null){ cheaper='dijipin'; }
      else { cheaper='competitor'; }

    const tr=document.createElement('tr');
    tr.className='product-row';
    tr.dataset.name=r.name;
    tr.dataset.cheaper=cheaper;
    tr.dataset.diff=(diffPct==null?'':diffPct.toFixed(2));

    // Ürün
    const tdName=document.createElement('td'); tdName.textContent=r.name; tr.appendChild(tdName);

    // Dijipin
    const tdD=document.createElement('td'); tdD.className='text-end price';
    tdD.textContent=(r.dijipin==null?'-':fmt(r.dijipin));
    if(bestKeys.has('__dijipin__')){
      tdD.insertAdjacentHTML('beforeend',' <span class="badge bg-success-subtle text-success border border-success-subtle ms-2 best-pill">En Uygun</span>');
      tdD.classList.add('cell-best');
    }
    tr.appendChild(tdD);

    // Rakipler
    for(const comp of competitors){
      const cell=document.createElement('td'); cell.className='text-end price';
      const v=r.comps.get(comp.id)?.val;
      cell.textContent=(v==null?'-':fmt(v));
      if(bestKeys.has(comp.id)){
        cell.insertAdjacentHTML('beforeend',' <span class="badge bg-success-subtle text-success border border-success-subtle ms-2 best-pill">En Uygun</span>');
        cell.classList.add('cell-best');
      }
      tr.appendChild(cell);
    }

    // Fark % (sayı + mini bar)
    const tdDiff=document.createElement('td'); tdDiff.className='text-end';
    if(diffPct==null || !isFinite(diffPct)) {
      tdDiff.innerHTML='<span class="text-muted">-</span>';
    } else {
      const color = diffPct>0 ? '#16a34a' : (diffPct<0 ? '#dc2626' : '#9ca3af');
      const sign  = diffPct>0?'+':'';
      const abs   = Math.min(Math.abs(diffPct), 100);
      tdDiff.innerHTML = `
        <div class="diff-wrap">
          <span style="color:${color}">${sign}${Number(diffPct).toFixed(2)}%</span>
          <span class="diff-bar"><i style="width:${abs}%; background:${color}"></i></span>
        </div>`;
    }
    tr.appendChild(tdDiff);

    // Etiket
    const tdTag=document.createElement('td'); tdTag.className='text-end';
    let who;
    if(bestKeys.has('__dijipin__')) who='Dijipin';
    else {
      const firstBest=[...bestKeys][0];
      who = competitors.find(c=>c.id===firstBest)?.label || 'Rakip';
    }
    tdTag.innerHTML = `<span class="badge ${bestKeys.has('__dijipin__') ? 'bg-success' : 'bg-primary'}">${who} en uygun</span>`;
    tr.appendChild(tdTag);

    // Satır tıkla -> modal
    tr.addEventListener('click', () => {
      const list = [];
      list.push(`<div class="d-flex justify-content-between"><b>Dijipin</b><span>${r.dijipin==null?'-':fmt(r.dijipin)}</span></div>`);
      for(const [sid,obj] of r.comps){
        list.push(`<div class="d-flex justify-content-between"><span>${obj.label||sid}</span><span>${fmt(obj.val)}</span></div>`);
      }
      document.getElementById('allPricesBody').innerHTML = list.join('');
      new bootstrap.Modal('#allPricesModal').show();
    });

    tbody.appendChild(tr);
  }

  // Boşsa "kayıt yok"
  if(!tbody.children.length){
    const cols = pane.querySelectorAll('thead th').length;
    const tr=document.createElement('tr'); tr.className='__empty';
    tr.innerHTML = `<td colspan="${cols}" class="text-center text-muted">Kayıt yok</td>`;
    tbody.appendChild(tr);
  }
}
</script>
</body>
</html>
